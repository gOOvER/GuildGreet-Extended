name: Code Quality

on:
  push:
    branches: [ master, main, dev, develop ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'

jobs:
  luacheck:
    name: Lua Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Lua and luacheck
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.1 luarocks
        sudo luarocks install luacheck
        
    - name: Run luacheck on addon files
      run: |
        echo "Running luacheck on addon files..."
        
        # List files to be checked
        echo "Lua files found:"
        find . -name "*.lua" -type f | wc -l
        
        # Test luacheck functionality first
        echo 'print("test")' > test_minimal.lua
        if luacheck test_minimal.lua > /dev/null 2>&1; then
          echo "‚úÖ Luacheck is functional"
          rm test_minimal.lua
          
          # Use find command with exec to handle file arguments properly
          echo "Running comprehensive luacheck analysis..."
          find . -name "*.lua" -type f -exec luacheck --no-color --codes --ignore 111 112 113 {} + > luacheck_output.txt 2>&1 || true
          
          # Show results
          echo "Luacheck analysis complete:"
          cat luacheck_output.txt
          
          # Check for syntax errors vs warnings
          if grep -q "/ 0 errors" luacheck_output.txt; then
            echo ""
            echo "‚úÖ PASS: No syntax errors detected"
            
            # Extract statistics
            if grep -q "Total:" luacheck_output.txt; then
              summary_line=$(grep "Total:" luacheck_output.txt | tail -1)
              echo "üìä Summary: $summary_line"
            fi
            
            echo ""
            echo "‚ÑπÔ∏è  Code quality analysis complete:"
            echo "   ‚Ä¢ All files have valid Lua syntax"
            echo "   ‚Ä¢ Warnings are normal for WoW addons"
            echo "   ‚Ä¢ Complex API usage triggers expected warnings"
            
          else
            echo ""
            echo "‚ùå FAIL: Syntax errors found that need fixing"
            exit 1
          fi
          
        else
          echo "‚ö†Ô∏è Luacheck not functional, using basic syntax check"
          rm -f test_minimal.lua
          
          # Fallback to basic Lua syntax checking
          echo "Performing basic Lua syntax validation..."
          syntax_errors=0
          total_files=0
          
          for file in $(find . -name "*.lua" -type f); do
            total_files=$((total_files + 1))
            if ! lua -c "$file" > /dev/null 2>&1; then
              echo "‚ùå Syntax error in: $file"
              syntax_errors=$((syntax_errors + 1))
            fi
          done
          
          echo ""
          echo "üìä Basic syntax check results:"
          echo "   Files checked: $total_files"
          echo "   Syntax errors: $syntax_errors"
          
          if [ $syntax_errors -eq 0 ]; then
            echo "‚úÖ PASS: All files have valid Lua syntax"
          else
            echo "‚ùå FAIL: Found syntax errors in $syntax_errors files"
            exit 1
          fi
        fi
            
            # Show that warnings are acceptable
            if grep -q "warnings" luacheck_output.txt; then
              echo "‚ö†Ô∏è  Warnings found but acceptable for WoW addons with complex API dependencies"
            fi
            
            echo ""
            echo "‚ÑπÔ∏è  WoW addons commonly trigger luacheck warnings due to:"
            echo "   ‚Ä¢ Hundreds of undocumented API functions"  
            echo "   ‚Ä¢ Dynamic global variable creation"
            echo "   ‚Ä¢ Complex event-driven architecture"
            echo "   ‚Ä¢ Legacy compatibility patterns"
            
          else
            echo "‚ùå FAIL: Syntax errors found that require fixing"
            cat luacheck_output.txt
            exit 1
          fi
        fi
        
        # Cleanup
        rm -f luacheck_output.txt
        
    - name: Generate code quality report
      run: |
        echo "## üîç Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "### Luacheck Results" >> $GITHUB_STEP_SUMMARY
        
        # Run luacheck with configuration and capture output
        if [ -f ".luacheckrc" ]; then
          if luacheck --no-color --formatter=plain . > luacheck_output.txt 2>&1; then
            echo "‚úÖ **No issues found in addon files**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Issues found in addon files:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 luacheck_output.txt >> $GITHUB_STEP_SUMMARY  # Limit output
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          # Fallback to basic checking
          if luacheck --no-color --formatter=plain GuildGreet.lua > luacheck_output.txt 2>&1; then
            echo "‚úÖ **No issues found in main file**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Issues found in main file:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat luacheck_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        fi

  toc-validation:
    name: TOC File Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate TOC structure
      run: |
        echo "Validating TOC file structure..."
        
        # Check if TOC file exists
        if [ ! -f "GuildGreet.toc" ]; then
          echo "‚ùå TOC file not found!"
          exit 1
        fi
        
        echo "‚úÖ TOC file found"
        
        # Extract and validate required fields
        INTERFACE=$(grep "## Interface:" GuildGreet.toc | head -1 | cut -d' ' -f3)
        TITLE=$(grep "## Title:" GuildGreet.toc | cut -d' ' -f3-)
        VERSION=$(grep "## Version:" GuildGreet.toc | cut -d' ' -f3)
        AUTHOR=$(grep "## Author:" GuildGreet.toc | cut -d' ' -f3-)
        
        echo "Found TOC fields:"
        echo "  Interface: $INTERFACE"
        echo "  Title: $TITLE"
        echo "  Version: $VERSION"
        echo "  Author: $AUTHOR"
        
        # Validate interface versions
        echo "Checking interface versions..."
        
        RETAIL_INTERFACE=$(grep "## Interface-Retail:" GuildGreet.toc | cut -d' ' -f3 || echo $INTERFACE)
        CLASSIC_INTERFACE=$(grep "## Interface-Classic:" GuildGreet.toc | cut -d' ' -f3)
        BCC_INTERFACE=$(grep "## Interface-BCC:" GuildGreet.toc | cut -d' ' -f3)
        WRATH_INTERFACE=$(grep "## Interface-Wrath:" GuildGreet.toc | cut -d' ' -f3)
        CATA_INTERFACE=$(grep "## Interface-Cata:" GuildGreet.toc | cut -d' ' -f3)
        
        # Validate version format
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ö†Ô∏è Version format should be X.Y.Z, found: $VERSION"
        else
          echo "‚úÖ Version format is valid: $VERSION"
        fi
        
    - name: Check for required files mentioned in TOC
      run: |
        echo "Checking file references..."
        while IFS= read -r line; do
          # Skip comments and empty lines
          if [[ $line =~ ^[[:space:]]*# ]] || [[ -z "${line// }" ]]; then
            continue
          fi
          
          # Skip #@no-lib-strip@ blocks
          if [[ $line =~ ^#@.*@$ ]]; then
            continue
          fi
          
          # Check if file exists
          filename=$(echo "$line" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
          if [ -n "$filename" ]; then
            if [ -f "$filename" ]; then
              echo "‚úÖ File found: $filename"
            else
              echo "‚ö†Ô∏è File not found: $filename"
            fi
          fi
        done < <(tail -n +10 GuildGreet.toc)  # Skip first 10 lines (headers)
        
    - name: Generate TOC validation report
      run: |
        echo "## üìã TOC Validation Report" >> $GITHUB_STEP_SUMMARY
        
        VERSION=$(grep "## Version:" GuildGreet.toc | cut -d' ' -f3)
        INTERFACE=$(grep "## Interface:" GuildGreet.toc | head -1 | cut -d' ' -f3)
        
        echo "### Current Version Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- **Main Interface:** $INTERFACE" >> $GITHUB_STEP_SUMMARY
        
        echo "### Interface Compatibility" >> $GITHUB_STEP_SUMMARY
        echo "| Version | Interface | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Check each interface version
        for variant in "Retail" "Classic" "BCC" "Wrath" "Cata"; do
          interface_line=$(grep "## Interface-$variant:" GuildGreet.toc || echo "")
          if [ -n "$interface_line" ]; then
            interface_version=$(echo "$interface_line" | cut -d' ' -f3)
            echo "| $variant | $interface_version | ‚úÖ Supported |" >> $GITHUB_STEP_SUMMARY
          else
            if [ "$variant" = "Retail" ]; then
              echo "| $variant | $INTERFACE | ‚úÖ Default |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $variant | - | ‚ùå Not specified |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Scan for sensitive patterns
      run: |
        echo "Scanning for potential security issues..."
        
        # Check for common security anti-patterns in Lua/WoW addons
        echo "## üîí Security Scan Results" >> $GITHUB_STEP_SUMMARY
        
        security_issues=0
        
        # Check for potentially dangerous functions
        dangerous_patterns=(
          "RunScript"
          "loadstring" 
          "dofile"
          "load"
          "getfenv"
          "setfenv"
        )
        
        for pattern in "${dangerous_patterns[@]}"; do
          if grep -r "$pattern" *.lua 2>/dev/null; then
            echo "‚ö†Ô∏è Found potentially dangerous function: $pattern" >> $GITHUB_STEP_SUMMARY
            security_issues=$((security_issues + 1))
          fi
        done
        
        # Check for hardcoded secrets/tokens
        secret_patterns=(
          "password.*="
          "token.*="
          "key.*="
          "secret.*="
        )
        
        for pattern in "${secret_patterns[@]}"; do
          if grep -i "$pattern" *.lua 2>/dev/null; then
            echo "‚ö†Ô∏è Potential hardcoded secret found: $pattern" >> $GITHUB_STEP_SUMMARY
            security_issues=$((security_issues + 1))
          fi
        done
        
        if [ $security_issues -eq 0 ]; then
          echo "‚úÖ **No security issues detected**" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è **$security_issues potential security issues found**" >> $GITHUB_STEP_SUMMARY
        fi

  addon-metadata:
    name: Addon Metadata Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Extract and validate metadata
      run: |
        echo "## üìä Addon Metadata" >> $GITHUB_STEP_SUMMARY
        
        # Extract metadata from TOC
        TITLE=$(grep "## Title:" GuildGreet.toc | cut -d' ' -f3-)
        NOTES=$(grep "## Notes:" GuildGreet.toc | cut -d' ' -f3-)
        AUTHOR=$(grep "## Author:" GuildGreet.toc | cut -d' ' -f3-)
        VERSION=$(grep "## Version:" GuildGreet.toc | cut -d' ' -f3)
        WEBSITE=$(grep "## X-Website:" GuildGreet.toc | cut -d' ' -f3-)
        CURSE_ID=$(grep "## X-Curse-Project-ID:" GuildGreet.toc | cut -d' ' -f3)
        WOWI_ID=$(grep "## X-WoWI-ID:" GuildGreet.toc | cut -d' ' -f3)
        WAGO_ID=$(grep "## X-Wago-ID:" GuildGreet.toc | cut -d' ' -f3)
        
        echo "### Basic Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Title:** $TITLE" >> $GITHUB_STEP_SUMMARY
        echo "- **Description:** $NOTES" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** $AUTHOR" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- **Website:** $WEBSITE" >> $GITHUB_STEP_SUMMARY
        
        echo "### Platform Integration" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | ID | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CurseForge | $CURSE_ID | $([ -n "$CURSE_ID" ] && echo "‚úÖ Configured" || echo "‚ùå Missing") |" >> $GITHUB_STEP_SUMMARY
        echo "| WoWInterface | $WOWI_ID | $([ -n "$WOWI_ID" ] && echo "‚úÖ Configured" || echo "‚ùå Missing") |" >> $GITHUB_STEP_SUMMARY
        echo "| Wago | $WAGO_ID | $([ -n "$WAGO_ID" ] && echo "‚úÖ Configured" || echo "‚ùå Missing") |" >> $GITHUB_STEP_SUMMARY
        
        # Check for missing locale files
        echo "### Localization Status" >> $GITHUB_STEP_SUMMARY
        if [ -d "lang" ]; then
          locale_count=$(find lang -name "*.lua" | wc -l)
          echo "- **Locale files:** $locale_count found" >> $GITHUB_STEP_SUMMARY
          echo "- **Languages:** $(find lang -name "*.lua" | sed 's|lang/||' | sed 's|\.lua||' | sort | tr '\n' ', ' | sed 's|, $||')" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Locale files:** None found" >> $GITHUB_STEP_SUMMARY
        fi