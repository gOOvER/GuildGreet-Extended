name: Release

on:
  push:
    tags:
      - 'v*'              # Traditional v-prefixed tags (v1.0.0)
      - '[0-9]*'          # Semantic version tags (11.0.0-alpha1)
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 11.0.0-alpha1 or 11.1.0-beta1)'
        required: true
        type: string
      create_tag:
        description: 'Create git tag'
        required: true
        type: boolean
        default: true
      prerelease:
        description: 'Mark as prerelease (for beta/alpha versions)'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout addon
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Extract version from pushed tag
            VERSION=${GITHUB_REF#refs/tags/}
            echo "Detected tag: $VERSION"
            
            # Check if it's a prerelease (contains alpha, beta, rc)
            if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
              echo "prerelease=true" >> $GITHUB_OUTPUT
              echo "Detected prerelease version"
            else
              echo "prerelease=false" >> $GITHUB_OUTPUT
              echo "Detected stable release version"
            fi
          else
            # Manual workflow dispatch
            VERSION="${{ github.event.inputs.version }}"
            echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
            echo "Manual release version: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version set to: $VERSION"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: GuildGreet-Extended ${{ steps.version.outputs.version }}
          body: |
            ## GuildGreet-Extended ${{ steps.version.outputs.version }}
            
            ### ðŸš€ Major Updates
            - Complete modular architecture with 70.09% code reduction
            - 15 specialized libraries for enhanced performance
            - Modern TOC structure with multi-version WoW support
            
            ### ðŸ“¦ Downloads
            - **Main Package**: Includes all dependencies
            - **NoLib Package**: For users with shared libraries
            
            ### ðŸŽ¯ Compatibility
            - âœ… Retail (11.0.5)
            - âœ… Classic Era (1.15.8) 
            - âœ… Burning Crusade Classic (2.5.4)
            - âœ… Wrath Classic (3.4.3)
            - âœ… Cataclysm Classic (4.4.0)
            
            **Downloads are automatically uploaded to CurseForge and Wago.io**
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease }}

      - name: Package addon
        uses: BigWigsMods/packager@v2
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
          WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
          GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: -g ${{ steps.create_release.outputs.id }}