name: Tests

on:
  push:
    branches: [ master, main, dev, develop ]
  pull_request:
    branches: [ master, main ]

jobs:
  lua-syntax:
    name: Lua Syntax Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Lua
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.1 luarocks
        
    - name: Install luacheck
      run: |
        sudo luarocks install luacheck
        
    - name: Run luacheck
      run: |
        echo "Running luacheck for basic syntax checking..."
        
        # List files to be checked
        echo "Files to check:"
        find . -name "*.lua" -type f | head -10
        
        # Test if luacheck is working at all
        echo "Testing luacheck installation..."
        luacheck --version || echo "Luacheck version check failed"
        
        # Create a minimal test file to verify luacheck functionality
        echo 'print("test")' > test_minimal.lua
        
        # Try to run luacheck on the test file
        if luacheck test_minimal.lua > test_result.txt 2>&1; then
          echo "‚úÖ Luacheck is functional"
          rm test_minimal.lua test_result.txt
          
          # Create array of lua files and process them individually
          echo "Processing Lua files individually to avoid argument issues..."
          
          total_errors=0
          total_warnings=0
          files_processed=0
          
          # Process each lua file found
          for lua_file in $(find . -name "*.lua" -type f); do
            if [ -f "$lua_file" ]; then
              files_processed=$((files_processed + 1))
              echo "Processing: $lua_file"
              
              # Run luacheck on single file
              if luacheck --no-color --codes --ignore 111 112 113 "$lua_file" > single_result.txt 2>&1; then
                # Success - check for warnings
                if [ -s single_result.txt ]; then
                  cat single_result.txt
                  warnings=$(grep -c "warning" single_result.txt 2>/dev/null || echo "0")
                  total_warnings=$((total_warnings + warnings))
                fi
              else
                # Error - display and count
                cat single_result.txt
                if grep -q "syntax error\|Error:" single_result.txt; then
                  total_errors=$((total_errors + 1))
                else
                  # Might be warnings causing non-zero exit
                  warnings=$(grep -c "warning" single_result.txt 2>/dev/null || echo "0")
                  total_warnings=$((total_warnings + warnings))
                fi
              fi
              rm -f single_result.txt
            fi
          done
          
          echo ""
          echo "üìä Luacheck Results:"
          echo "Files processed: $files_processed"
          echo "Warnings: $total_warnings"
          echo "Errors: $total_errors"
          
          if [ $total_errors -gt 0 ]; then
            echo "‚ùå FAIL: Found $total_errors syntax errors"
            exit 1
          else
            echo "‚úÖ PASS: No syntax errors found"
            if [ $total_warnings -gt 0 ]; then
              echo "‚ÑπÔ∏è Found $total_warnings warnings (normal for WoW addons)"
            fi
          fi
          
        else
          echo "‚ùå Luacheck is not functional, falling back to basic Lua syntax check"
          rm -f test_minimal.lua test_result.txt
          
          # Basic Lua syntax check using lua -c (compile check)
          echo "Performing basic Lua syntax validation..."
          syntax_errors=0
          files_checked=0
          
          for file in $(find . -name "*.lua" -type f); do
            echo "Checking: $file"
            files_checked=$((files_checked + 1))
            if ! lua -c "$file" > /dev/null 2>&1; then
              echo "‚ùå Syntax error in: $file"
              lua -c "$file"
              syntax_errors=$((syntax_errors + 1))
            fi
          done
          
          echo ""
          echo "üìä Basic Syntax Check Results:"
          echo "Files checked: $files_checked"
          echo "Syntax errors: $syntax_errors"
          
          if [ $syntax_errors -eq 0 ]; then
            echo "‚úÖ PASS: All Lua files have valid syntax"
            echo "‚ÑπÔ∏è Basic syntax check completed (luacheck unavailable)"
          else
            echo "‚ùå FAIL: Found $syntax_errors files with syntax errors"
            exit 1
          fi
        fi
        
    - name: Check TOC files
      run: |
        echo "Validating TOC file format..."
        if [ -f "GuildGreet.toc" ]; then
          echo "‚úì TOC file exists"
          grep -q "## Interface:" GuildGreet.toc && echo "‚úì Interface version found" || exit 1
          grep -q "## Title:" GuildGreet.toc && echo "‚úì Title found" || exit 1
          grep -q "## Version:" GuildGreet.toc && echo "‚úì Version found" || exit 1
          echo "‚úÖ TOC file validation passed"
        else
          echo "‚ùå TOC file missing"
          exit 1
        fi

  validate-structure:
    name: Validate Addon Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate addon structure
      run: |
        echo "Validating WoW addon structure..."
        
        # Check required files
        [ -f "GuildGreet.toc" ] && echo "‚úì TOC file present" || (echo "‚úó TOC file missing" && exit 1)
        [ -f "GuildGreet.lua" ] && echo "‚úì Main Lua file present" || (echo "‚úó Main Lua file missing" && exit 1)
        [ -f "embeds.xml" ] && echo "‚úì Embeds file present" || echo "‚ö† Embeds file missing (optional)"
        [ -f "Bindings.xml" ] && echo "‚úì Bindings file present" || echo "‚ö† Bindings file missing (optional)"
        [ -f "GuildGreet.xml" ] && echo "‚úì GUI XML file present" || echo "‚ö† GUI XML file missing (optional)"
        
        # Check locale structure
        if [ -d "lang" ]; then
          echo "‚úì Localization directory present"
          locale_count=$(find lang -name "*.lua" | wc -l)
          echo "  Found $locale_count locale files"
          
          # Check for required locale files
          [ -f "lang/locale.xml" ] && echo "‚úì Locale XML present" || echo "‚ö† Locale XML missing"
          [ -f "lang/enUS.lua" ] && echo "‚úì English locale present" || echo "‚ö† English locale missing"
        fi
        
        # Check documentation
        [ -f "README.md" ] && echo "‚úì README present" || echo "‚ö† README missing"
        [ -f "LICENCE.md" ] && echo "‚úì License present" || echo "‚ö† License missing"
        
        echo "‚úÖ Addon structure validation completed successfully!"